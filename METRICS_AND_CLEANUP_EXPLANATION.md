# üìä –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ: –ú–µ—Ç—Ä–∏–∫–∏ Prometheus –∏ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## 1. üìà –ú–µ—Ç—Ä–∏–∫–∏ Prometheus

### –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

**Prometheus** ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ú–µ—Ç—Ä–∏–∫–∏ ‚Äî —ç—Ç–æ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –≤–∞—à–µ–º –±–æ—Ç–µ?

–ë–æ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ —á–µ—Ä–µ–∑ HTTP endpoint `/metrics` –Ω–∞ –ø–æ—Ä—Ç—É `:8080` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é). –≠—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ —Å–æ–±–∏—Ä–∞—Ç—å —Å –ø–æ–º–æ—â—å—é Prometheus Server –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –∞–ª–µ—Ä—Ç–æ–≤.

### –ö–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è?

#### 1. **–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** (`feedback_bot_active_users_total`)
```go
// –¢–∏–ø: Gauge (—Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–æ—Ç–∞
```

**–ö–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:**
```go
// –í internal/telegram/bot.go
func (b *Bot) updateActiveUsersMetric() {
    b.svcMu.RLock()
    count := len(b.services)  // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
    b.svcMu.RUnlock()
    metrics.UpdateActiveUsers(count)  // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É
}

// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏:
// - –°–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// - –£–¥–∞–ª–µ–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–∞
// - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
```

**–ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è:**
```
feedback_bot_active_users_total 15
```
–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω–æ 15 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

---

#### 2. **–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤—ã** (`feedback_bot_processed_feedbacks_total`)
```go
// –¢–∏–ø: Counter (—Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è)
// –ú–µ—Ç–∫–∏: user_id (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è), status (answered/skipped/failed)
```

**–ö–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:**
```go
// –í internal/service/cycle.go
if err := s.store.Save(ctx, s.userID, fb.ID); err != nil {
    metrics.IncrementDatabaseError("save")
} else {
    answered++
    metrics.IncrementProcessedFeedback(s.userID, "answered")  // ‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
}

// –î–ª—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤:
metrics.IncrementProcessedFeedback(s.userID, "skipped")  // ‚è≠Ô∏è –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Ä–∞–Ω–µ–µ

// –î–ª—è –æ—à–∏–±–æ–∫:
metrics.IncrementProcessedFeedback(s.userID, "failed")  // ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ
```

**–ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è:**
```
feedback_bot_processed_feedbacks_total{user_id="123456789",status="answered"} 150
feedback_bot_processed_feedbacks_total{user_id="123456789",status="skipped"} 45
feedback_bot_processed_feedbacks_total{user_id="123456789",status="failed"} 3
```
–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª 150 –æ—Ç–∑—ã–≤–æ–≤
- –ü—Ä–æ–ø—É—Å—Ç–∏–ª 45 (—É–∂–µ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Ä–∞–Ω–µ–µ)
- –ü–æ–ª—É—á–∏–ª –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ 3 –æ—Ç–∑—ã–≤–æ–≤

---

#### 3. **–ü—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞** (`feedback_bot_rate_limit_hits_total`)
```go
// –¢–∏–ø: Counter
// –ú–µ—Ç–∫–∞: user_id
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–ö–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:**
```go
// –í internal/telegram/bot.go
if !b.checkRateLimit(chatID) {
    metrics.IncrementRateLimitHit(chatID)  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç
    b.SendMessage(chatID, "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤...")
    return
}
```

**–ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è:**
```
feedback_bot_rate_limit_hits_total{user_id="123456789"} 5
```
–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ 5 —Ä–∞–∑.

---

#### 4. **–û—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** (`feedback_bot_database_errors_total`)
```go
// –¢–∏–ø: Counter
// –ú–µ—Ç–∫–∞: operation (get_config, save_config, exists, save)
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –°–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ –ë–î –ø—Ä–æ–∏–∑–æ—à–ª–æ –ø–æ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
```

**–ö–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:**
```go
// –ü—Ä–∏–º–µ—Ä—ã –∏–∑ –∫–æ–¥–∞:
cfg, err := b.configStore.GetUserConfig(dbCtx, chatID)
if err != nil {
    metrics.IncrementDatabaseError("get_config")  // –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
}

exists, err := s.store.Exists(ctx, s.userID, fb.ID)
if err != nil {
    metrics.IncrementDatabaseError("exists")  // –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
}
```

**–ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è:**
```
feedback_bot_database_errors_total{operation="get_config"} 2
feedback_bot_database_errors_total{operation="save_config"} 1
feedback_bot_database_errors_total{operation="exists"} 0
```

---

#### 5. **–û—à–∏–±–∫–∏ API** (`feedback_bot_api_errors_total`)
```go
// –¢–∏–ø: Counter
// –ú–µ—Ç–∫–∏: api (wb, telegram), operation (fetch, answer, send_message)
```

**–ö–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:**
```go
// –û—à–∏–±–∫–∏ Wildberries API:
feedbacks, err := s.client.FetchUnanswered(ctx, s.take, 0)
if err != nil {
    metrics.IncrementAPIError("wb", "fetch")  // –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤
}

if err := s.client.AnswerFeedback(ctx, fb.ID, tpl); err != nil {
    metrics.IncrementAPIError("wb", "answer")  // –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
}

// –û—à–∏–±–∫–∏ Telegram API:
_, err := b.api.Send(msg)
if err != nil {
    metrics.IncrementAPIError("telegram", "send_message")  // –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
}
```

**–ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è:**
```
feedback_bot_api_errors_total{api="wb",operation="fetch"} 3
feedback_bot_api_errors_total{api="wb",operation="answer"} 7
feedback_bot_api_errors_total{api="telegram",operation="send_message"} 1
```

---

### –ö–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ—Ç—Ä–∏–∫–∏?

#### 1. –ü—Ä—è–º–æ–π –ø—Ä–æ—Å–º–æ—Ç—Ä —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä:
```
http://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä:8080/metrics
```

#### 2. –ß–µ—Ä–µ–∑ curl:
```bash
curl http://localhost:8080/metrics
```

#### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Prometheus Server (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `prometheus.yml`:
```yaml
scrape_configs:
  - job_name: 'feedback-bot'
    static_configs:
      - targets: ['localhost:8080']
```

–ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ Prometheus:
```bash
prometheus --config.file=prometheus.yml
```

–ú–µ—Ç—Ä–∏–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Prometheus UI –Ω–∞ `http://localhost:    9090`

---

## 2. üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

–≠—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (RAM), —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –¥–æ–ª–≥–æ–π —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞.

### –ü–æ—á–µ–º—É —ç—Ç–æ –Ω—É–∂–Ω–æ?

–ë–æ—Ç —Ö—Ä–∞–Ω–∏—Ç –≤ –ø–∞–º—è—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- `userStates` ‚Äî —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–∏–∞–ª–æ–≥–µ
- `userConfig` ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `userRateLimiters` ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª–∏ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Å—Ç–∞–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞, –Ω–æ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–ª–∏—Å—å –≤ –ø–∞–º—è—Ç–∏, —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —É—Ç–µ—á–∫–µ –ø–∞–º—è—Ç–∏. –û—Å–æ–±–µ–Ω–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (100+).

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

#### –®–∞–≥ 1: –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –≥–æ—Ä—É—Ç–∏–Ω—ã
```go
// –í internal/telegram/bot.go, —Ñ—É–Ω–∫—Ü–∏—è Run()
func (b *Bot) Run(ctx context.Context) {
    // ...
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É –∫–∞–∂–¥—ã–π —á–∞—Å
    go b.cleanupInactiveUsers(ctx)
    
    // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—Ç–∞...
}
```

#### –®–∞–≥ 2: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
```go
// cleanupInactiveUsers –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
func (b *Bot) cleanupInactiveUsers(ctx context.Context) {
    ticker := time.NewTicker(1 * time.Hour)  // –ö–∞–∂–¥—ã–π —á–∞—Å
    defer ticker.Stop()
    
    for {
        select {
        case <-ctx.Done():
            return  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –±–æ—Ç–∞
        case <-ticker.C:
            b.performCleanup()  // –í—ã–ø–æ–ª–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É
        }
    }
}
```

#### –®–∞–≥ 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```go
func (b *Bot) performCleanup() {
    b.mu.Lock()
    defer b.mu.Unlock()
    
    // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    // –ê–∫—Ç–∏–≤–Ω—ã–π = —Ç–æ—Ç, —É –∫–æ–≥–æ –µ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–∏–π —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–∑—ã–≤–æ–≤
    b.svcMu.RLock()
    activeUserIDs := make(map[int64]bool)
    for chatID := range b.services {
        activeUserIDs[chatID] = true  // –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω
    }
    b.svcMu.RUnlock()
    
    // 2. –û—á–∏—â–∞–µ–º userStates (—Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤)
    for chatID := range b.userStates {
        if !activeUserIDs[chatID] {
            delete(b.userStates, chatID)  // –£–¥–∞–ª—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ
        }
    }
    
    // 3. –û—á–∏—â–∞–µ–º userConfig (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
    for chatID := range b.userConfig {
        if !activeUserIDs[chatID] {
            delete(b.userConfig, chatID)  // –£–¥–∞–ª—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ
        }
    }
    
    // 4. –û—á–∏—â–∞–µ–º rate limiters (–æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤)
    b.rateLimitMu.Lock()
    for chatID := range b.userRateLimiters {
        if !activeUserIDs[chatID] {
            delete(b.userRateLimiters, chatID)  // –£–¥–∞–ª—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ
        }
    }
    b.rateLimitMu.Unlock()
    
    // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    b.log.Debugw("cleanup completed", 
        "user_states", len(b.userStates),
        "user_configs", len(b.userConfig),
        "rate_limiters", len(b.userRateLimiters))
}
```

### –ö—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º?

**–ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —É –∫–æ—Ç–æ—Ä–æ–≥–æ:
1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω —Ç–æ–∫–µ–Ω Wildberries
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —à–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤
3. ‚úÖ –ó–∞–ø—É—â–µ–Ω —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–∑—ã–≤–æ–≤ (–µ—Å—Ç—å –∑–∞–ø–∏—Å—å –≤ `b.services`)

**–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π:
- ‚ùå –ù–∞—á–∞–ª –Ω–∞—Å—Ç—Ä–æ–π–∫—É, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª
- ‚ùå –û—Å—Ç–∞–Ω–æ–≤–∏–ª —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–∏—Å–∞ (—É–¥–∞–ª–∏–ª –¥–∞–Ω–Ω—ã–µ)
- ‚ùå –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞

### –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

**–î–æ –æ—á–∏—Å—Ç–∫–∏:**
```
userStates: {123: StateWaitingToken, 456: StateIdle, 789: StateReady}
userConfig: {123: {...}, 456: {...}, 789: {...}}
services: {789: Service{...}}  // –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 789 –∞–∫—Ç–∏–≤–µ–Ω
```

**–ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:**
```
userStates: {789: StateReady}  // –£–¥–∞–ª–µ–Ω—ã 123 –∏ 456
userConfig: {789: {...}}      // –£–¥–∞–ª–µ–Ω—ã 123 –∏ 456
services: {789: Service{...}}  // –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
```

### –ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—á–∏—Å—Ç–∫–∞?

- ‚è∞ **–ö–∞–∂–¥—ã–π —á–∞—Å** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- üîÑ –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞
- üõë –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –±–æ—Ç–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

### –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å!

1. **–û—á–∏—Å—Ç–∫–∞ –ù–ï —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏
2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î** –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
3. **–û—á–∏—Å—Ç–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞** ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è
4. **–£–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –º–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ = –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–±–æ—Ç–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ—á–∏—Å—Ç–∫–∏ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å:
```
{"level":"debug","msg":"cleanup completed","user_states":5,"user_configs":5,"rate_limiters":3}
```

–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏.

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              –ë–û–¢ –ó–ê–ü–£–©–ï–ù                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚îú‚îÄ‚ñ∫ –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
                    ‚îÇ
                    ‚îú‚îÄ‚ñ∫ –û—á–∏—Å—Ç–∫–∞ (–∫–∞–∂–¥—ã–π —á–∞—Å)
                    ‚îÇ   ‚îî‚îÄ‚ñ∫ –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–∑ –ø–∞–º—è—Ç–∏
                    ‚îÇ
                    ‚îî‚îÄ‚ñ∫ –ú–µ—Ç—Ä–∏–∫–∏ (HTTP endpoint :8080/metrics)
                        ‚îú‚îÄ‚ñ∫ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                        ‚îú‚îÄ‚ñ∫ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤—ã
                        ‚îú‚îÄ‚ñ∫ –û—à–∏–±–∫–∏ API
                        ‚îî‚îÄ‚ñ∫ –û—à–∏–±–∫–∏ –ë–î
```

–û–±–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!

